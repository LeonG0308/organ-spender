<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organspende-Präferenz - Admin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <style>
        /* Global Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background-color: #6247AA; /* PowerPoint purple */
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .hidden {
            display: none;
        }

        h1, h2, h3 {
            margin-bottom: 1rem;
        }

        p {
            margin-bottom: 1rem;
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 4px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            transition: background-color 0.3s, transform 0.1s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }
        
        .login-container {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .login-form input {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .error {
            color: #f44336;
            font-size: 0.9rem;
        }

        .admin-dashboard {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background-color: transparent;
            color: #666;
            border: none;
            border-bottom: 3px solid transparent;
            border-radius: 0;
            margin-right: 1rem;
        }

        .tab-btn:hover {
            color: #333;
            transform: none;
        }

        .tab-btn.active {
            color: #6247AA; /* PowerPoint purple */
            border-bottom-color: #6247AA; /* PowerPoint purple */
            font-weight: bold;
        }

        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            margin: 2rem 0;
        }

        .chart-container {
            flex: 1;
            min-width: 300px;
            height: 300px; /* Reduced height */
            position: relative; /* Wichtig für Chart.js */
        }

        .stats-summary {
            flex: 0 0 250px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .stat-label {
            font-weight: bold;
        }

        .stat-value {
            font-size: 1.2rem;
            color: #6247AA; /* PowerPoint purple */
        }

        .admin-controls {
            display: flex;
            gap: 1rem;
            margin-top: 2rem; /* Mehr Abstand nach oben */
            margin-bottom: 1rem; /* Abstand nach unten */
        }

        .btn-refresh {
            background-color: #6247AA; /* PowerPoint purple */
            color: white;
        }

        .btn-reset {
            background-color: #f44336;
            color: white;
        }

        .btn-refresh:hover {
            background-color: #513c8c; /* Darker purple */
        }

        .btn-reset:hover {
            background-color: #d32f2f;
        }

        .btn-download {
            background-color: #4CAF50; /* Green */
            color: white;
        }

        .btn-download:hover {
            background-color: #45a049; /* Darker green */
        }

        .reset-confirm {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
        }

        .reset-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-cancel {
            background-color: #f1f1f1;
            color: #333;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-cancel:hover {
            background-color: #e5e5e5;
        }

        /* Defaults Dashboard Styles - Redesigned for better visibility */
        .defaults-dashboard-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .defaults-data-container {
            display: flex;
            flex-direction: row;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .defaults-chart-container {
            flex: 1;
            min-width: 600px;
            height: 400px;
            position: relative; /* Wichtig für Chart.js */
        }

        .category-container {
            flex: 1;
            min-width: 330px;
            max-height: 500px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 1rem;
        }

        .chart-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            padding: 0 1rem;
            text-align: center; /* Für bessere Zentrierung */
        }
        
        .chart-label {
            text-align: center;
            font-size: 0.85rem;
            color: #333;
            flex: 1;
        }

        .category-entries {
            margin-top: 1rem;
        }

        .category-header {
            padding: 0.5rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .category-title {
            font-weight: bold;
        }

        .category-count {
            background-color: #6247AA; /* PowerPoint purple */
            color: white;
            padding: 0.1rem 0.5rem;
            border-radius: 3px;
            font-size: 0.9rem;
        }

        .category-entries-list {
            margin: 0.5rem 0 1.5rem 0;
            padding-left: 1rem;
        }

        .entry-item {
            padding: 0.3rem 0;
            border-bottom: 1px dashed #ddd;
        }

        .entry-item:last-child {
            border-bottom: none;
        }

        /* Loading indicator */
        .loading {
            text-align: center;
            margin: 2rem 0;
            font-style: italic;
            color: #666;
        }

        @media (max-width: 768px) {
            .defaults-data-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Organspende-Präferenz - Administrations-Bereich</h1>
    </div>
    
    <div class="main-content">
        <div id="login-container" class="login-container">
            <h2>Admin Login</h2>
            <div class="login-form">
                <input type="password" id="password" placeholder="Passwort eingeben">
                <button id="login-btn" style="background-color: #6247AA; color: white;">Einloggen</button>
                <p id="login-error" class="error hidden">Falsches Passwort. Bitte versuchen Sie es erneut.</p>
            </div>
        </div>
        
        <div id="admin-dashboard" class="admin-dashboard hidden">
            <div class="dashboard-tabs">
                <button id="cookies-tab" class="tab-btn active">Cookie-Statistiken</button>
                <button id="survey-tab" class="tab-btn">Umfrage-Statistiken</button>
                <button id="defaults-tab" class="tab-btn">Default-Statistiken</button>
            </div>
            
            <!-- Cookie Dashboard -->
            <div id="cookie-dashboard" class="dashboard-content">
                <h2>Cookie-Statistiken</h2>
                
                <div id="cookie-loading" class="loading">Lade Daten...</div>
                
                <div class="stats-container">
                    <div class="chart-container">
                        <canvas id="cookie-chart"></canvas>
                    </div>
                    
                    <div class="stats-summary">
                        <div class="stat-item">
                            <span class="stat-label">Akzeptiert:</span>
                            <span id="accept-count" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Abgelehnt:</span>
                            <span id="reject-count" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Gesamt:</span>
                            <span id="total-count" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Akzeptanzrate:</span>
                            <span id="accept-rate" class="stat-value">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Buttons nun außerhalb der Chart-Container -->
                <div class="admin-controls">
                    <button id="refresh-cookies-btn" class="btn-refresh">Daten aktualisieren</button>
                    <button id="download-cookies-btn" class="btn-download">Daten herunterladen (CSV)</button>
                    <button id="reset-cookies-btn" class="btn-reset">Alle Daten zurücksetzen</button>
                </div>
                
                <div id="reset-cookies-confirm" class="reset-confirm hidden">
                    <p>Sind Sie sicher, dass Sie alle Cookie-Daten zurücksetzen möchten? Diese Aktion kann nicht rückgängig gemacht werden.</p>
                    <div class="reset-buttons">
                        <button id="confirm-reset-cookies" class="btn-danger">Ja, zurücksetzen</button>
                        <button id="cancel-reset-cookies" class="btn-cancel">Abbrechen</button>
                    </div>
                </div>
            </div>
            
            <!-- Survey Dashboard -->
            <div id="survey-dashboard" class="dashboard-content hidden">
                <h2>Umfrage-Statistiken</h2>
                
                <div id="survey-loading" class="loading">Lade Daten...</div>
                
                <div class="stats-container">
                    <div class="chart-container">
                        <canvas id="survey-chart"></canvas>
                    </div>
                    
                    <div class="stats-summary">
                        <div class="stat-item">
                            <span class="stat-label">Ja-Antworten:</span>
                            <span id="yes-count" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Nein-Antworten:</span>
                            <span id="no-count" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Gesamt:</span>
                            <span id="survey-total-count" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Zustimmungsrate:</span>
                            <span id="yes-rate" class="stat-value">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="admin-controls">
                    <button id="refresh-survey-btn" class="btn-refresh">Daten aktualisieren</button>
                    <button id="download-survey-btn" class="btn-download">Daten herunterladen (CSV)</button>
                    <button id="reset-survey-btn" class="btn-reset">Alle Daten zurücksetzen</button>
                </div>
                
                <div id="reset-survey-confirm" class="reset-confirm hidden">
                    <p>Sind Sie sicher, dass Sie alle Umfrage-Daten zurücksetzen möchten? Diese Aktion kann nicht rückgängig gemacht werden.</p>
                    <div class="reset-buttons">
                        <button id="confirm-reset-survey" class="btn-danger">Ja, zurücksetzen</button>
                        <button id="cancel-reset-survey" class="btn-cancel">Abbrechen</button>
                    </div>
                </div>
            </div>
            
            <!-- Defaults Dashboard - Redesigned -->
            <div id="defaults-dashboard" class="dashboard-content hidden">
                <h2>Default-Statistiken</h2>
                
                <div id="defaults-loading" class="loading">Lade Daten...</div>
                
                <div class="defaults-dashboard-container">
                    <div class="defaults-data-container">
                        <div class="defaults-chart-container">
                            <canvas id="defaults-chart"></canvas>
                            <div id="chart-labels" class="chart-labels">
                                <!-- Labels will be filled dynamically -->
                            </div>
                        </div>
                        
                        <div id="category-container" class="category-container">
                            <!-- Category entries will be filled dynamically -->
                        </div>
                    </div>
                    
                    <div class="admin-controls">
                        <button id="refresh-defaults-btn" class="btn-refresh">Daten aktualisieren</button>
                        <button id="download-defaults-btn" class="btn-download">Daten herunterladen (CSV)</button>
                        <button id="reset-defaults-btn" class="btn-reset">Alle Daten zurücksetzen</button>
                    </div>
                    
                    <div id="reset-defaults-confirm" class="reset-confirm hidden">
                        <p>Sind Sie sicher, dass Sie alle Default-Daten zurücksetzen möchten? Diese Aktion kann nicht rückgängig gemacht werden.</p>
                        <div class="reset-buttons">
                            <button id="confirm-reset-defaults" class="btn-danger">Ja, zurücksetzen</button>
                            <button id="cancel-reset-defaults" class="btn-cancel">Abbrechen</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK einbinden -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
     // Firebase Konfiguration
        const firebaseConfig = {
          apiKey: "AIzaSyDBSh0K7_XNcoNntyzivLeIfGaV_VCcw9U",
          authDomain: "organ-spender-tracking.firebaseapp.com",
          projectId: "organ-spender-tracking",
          storageBucket: "organ-spender-tracking.firebasestorage.app",
          messagingSenderId: "1057544964591",
          appId: "1:1057544964591:web:50cc361035c9dd79fdce1a"
        };
        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Konstanten und Variablen
        const correctPassword = "Umfrage";
        let cookieChart = null;
        let surveyChart = null;
        let defaultsChart = null;
        
        // Kategorie-Farben für das Default-Diagramm
        const categoryColors = {
            'gesund': 'rgba(98, 71, 170, 0.8)', // PowerPoint purple
            'ungesund': 'rgba(153, 225, 229, 0.8)', // PowerPoint light blue
            'spart Geld': 'rgba(159, 129, 219, 0.8)', // Light purple
            'kostet Geld': 'rgba(129, 212, 219, 0.8)', // Light blue
            'schützt Privatsphäre': 'rgba(177, 156, 217, 0.8)', // Another purple shade
            'verletzt Privatsphäre': 'rgba(179, 227, 229, 0.8)', // Another blue shade
            'fördert Nachhaltigkeit': 'rgba(119, 93, 191, 0.8)', // Another purple shade
            'ist umweltschädlich': 'rgba(110, 200, 209, 0.8)' // Another blue shade
        };
        
        const categoryBorderColors = {
            'gesund': 'rgba(98, 71, 170, 1)', // PowerPoint purple
            'ungesund': 'rgba(153, 225, 229, 1)', // PowerPoint light blue
            'spart Geld': 'rgba(159, 129, 219, 1)', // Light purple
            'kostet Geld': 'rgba(129, 212, 219, 1)', // Light blue
            'schützt Privatsphäre': 'rgba(177, 156, 217, 1)', // Another purple shade
            'verletzt Privatsphäre': 'rgba(179, 227, 229, 1)', // Another blue shade
            'fördert Nachhaltigkeit': 'rgba(119, 93, 191, 1)', // Another purple shade
            'ist umweltschädlich': 'rgba(110, 200, 209, 1)' // Another blue shade
        };
        
        // DOM-Elemente
        const loginBtn = document.getElementById("login-btn");
        const passwordField = document.getElementById("password");
        const loginError = document.getElementById("login-error");
        const loginContainer = document.getElementById("login-container");
        const adminDashboard = document.getElementById("admin-dashboard");
        
        // Tab-Elemente
        const cookiesTab = document.getElementById("cookies-tab");
        const surveyTab = document.getElementById("survey-tab");
        const defaultsTab = document.getElementById("defaults-tab");
        const cookieDashboard = document.getElementById("cookie-dashboard");
        const surveyDashboard = document.getElementById("survey-dashboard");
        const defaultsDashboard = document.getElementById("defaults-dashboard");
        
        // Cookie Dashboard Elemente
        const refreshCookiesBtn = document.getElementById("refresh-cookies-btn");
        const downloadCookiesBtn = document.getElementById("download-cookies-btn");
        const resetCookiesBtn = document.getElementById("reset-cookies-btn");
        const resetCookiesConfirm = document.getElementById("reset-cookies-confirm");
        const confirmResetCookies = document.getElementById("confirm-reset-cookies");
        const cancelResetCookies = document.getElementById("cancel-reset-cookies");
        
        // Survey Dashboard Elemente
        const refreshSurveyBtn = document.getElementById("refresh-survey-btn");
        const downloadSurveyBtn = document.getElementById("download-survey-btn");
        const resetSurveyBtn = document.getElementById("reset-survey-btn");
        const resetSurveyConfirm = document.getElementById("reset-survey-confirm");
        const confirmResetSurvey = document.getElementById("confirm-reset-survey");
        const cancelResetSurvey = document.getElementById("cancel-reset-survey");
        
        // Defaults Dashboard Elemente
        const refreshDefaultsBtn = document.getElementById("refresh-defaults-btn");
        const downloadDefaultsBtn = document.getElementById("download-defaults-btn");
        const resetDefaultsBtn = document.getElementById("reset-defaults-btn");
        const resetDefaultsConfirm = document.getElementById("reset-defaults-confirm");
        const confirmResetDefaults = document.getElementById("confirm-reset-defaults");
        const cancelResetDefaults = document.getElementById("cancel-reset-defaults");
        const categoryContainer = document.getElementById("category-container");
        const chartLabels = document.getElementById("chart-labels");
        
        // Beim Laden der Seite
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Seite geladen"); // Debug-Meldung
            
            // Event-Listener für Login-Button
            loginBtn.addEventListener("click", function() {
                login();
            });
            
            // Event-Listener für Enter-Taste im Passwort-Feld
            passwordField.addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    login();
                }
            });
            
            // Tab-Wechsel
            cookiesTab.addEventListener("click", function() {
                showTab('cookies-tab');
            });
            
            surveyTab.addEventListener("click", function() {
                showTab('survey-tab');
            });
            
            defaultsTab.addEventListener("click", function() {
                showTab('defaults-tab');
            });
            
            // Event-Listener für Cookie-Dashboard
            refreshCookiesBtn.addEventListener("click", function() {
                loadCookieData();
            });
            
            downloadCookiesBtn.addEventListener("click", function() {
                downloadCookieData();
            });
            
            resetCookiesBtn.addEventListener("click", function() {
                resetCookiesConfirm.classList.remove("hidden");
            });
            
            cancelResetCookies.addEventListener("click", function() {
                resetCookiesConfirm.classList.add("hidden");
            });
            
            confirmResetCookies.addEventListener("click", function() {
                resetCookieData();
            });
            
            // Event-Listener für Survey-Dashboard
            refreshSurveyBtn.addEventListener("click", function() {
                loadSurveyData();
            });
            
            downloadSurveyBtn.addEventListener("click", function() {
                downloadSurveyData();
            });
            
            resetSurveyBtn.addEventListener("click", function() {
                resetSurveyConfirm.classList.remove("hidden");
            });
            
            cancelResetSurvey.addEventListener("click", function() {
                resetSurveyConfirm.classList.add("hidden");
            });
            
            confirmResetSurvey.addEventListener("click", function() {
                resetSurveyData();
            });
            
            // Event-Listener für Defaults-Dashboard
            refreshDefaultsBtn.addEventListener("click", function() {
                loadDefaultsData();
            });
            
            downloadDefaultsBtn.addEventListener("click", function() {
                downloadDefaultsData();
            });
            
            resetDefaultsBtn.addEventListener("click", function() {
                resetDefaultsConfirm.classList.remove("hidden");
            });
            
            cancelResetDefaults.addEventListener("click", function() {
                resetDefaultsConfirm.classList.add("hidden");
            });
            
            confirmResetDefaults.addEventListener("click", function() {
                resetDefaultsData();
            });
        });
        
        // Login-Funktion
        function login() {
            console.log("Login-Funktion aufgerufen"); // Debug-Meldung
            const password = passwordField.value;
            
            if (password === correctPassword) {
                console.log("Passwort korrekt"); // Debug-Meldung
                loginContainer.classList.add("hidden");
                adminDashboard.classList.remove("hidden");
                
                // Lade Daten der aktiven Tab
                if (cookiesTab.classList.contains("active")) {
                    loadCookieData();
                } else if (surveyTab.classList.contains("active")) {
                    loadSurveyData();
                } else if (defaultsTab.classList.contains("active")) {
                    loadDefaultsData();
                }
                
                // Automatische Aktualisierung alle 30 Sekunden
                setInterval(function() {
                    if (cookiesTab.classList.contains("active")) {
                        loadCookieData();
                    } else if (surveyTab.classList.contains("active")) {
                        loadSurveyData();
                    } else if (defaultsTab.classList.contains("active")) {
                        loadDefaultsData();
                    }
                }, 30000);
            } else {
                console.log("Passwort falsch"); // Debug-Meldung
                loginError.classList.remove("hidden");
            }
        }
        
        // Tab anzeigen
        function showTab(tabId) {
            // Reset active classes
            cookiesTab.classList.remove("active");
            surveyTab.classList.remove("active");
            defaultsTab.classList.remove("active");
            cookieDashboard.classList.add("hidden");
            surveyDashboard.classList.add("hidden");
            defaultsDashboard.classList.add("hidden");
            
            // Set active tab
            if (tabId === 'cookies-tab') {
                cookiesTab.classList.add("active");
                cookieDashboard.classList.remove("hidden");
                loadCookieData();
            } else if (tabId === 'survey-tab') {
                surveyTab.classList.add("active");
                surveyDashboard.classList.remove("hidden");
                loadSurveyData();
            } else if (tabId === 'defaults-tab') {
                defaultsTab.classList.add("active");
                defaultsDashboard.classList.remove("hidden");
                loadDefaultsData();
            }
        }
        
        // ========== COOKIE DASHBOARD FUNCTIONS ==========
        
        // Cookie-Diagramm initialisieren
        function initCookieChart(acceptCount, rejectCount) {
            console.log("Cookie-Chart wird initialisiert"); // Debug-Meldung
            const ctx = document.getElementById('cookie-chart').getContext('2d');
            
            // Zerstöre vorhandenes Diagramm
            if (cookieChart !== null) {
                cookieChart.destroy();
            }
            
            cookieChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Cookies akzeptiert', 'Cookies abgelehnt'],
                    datasets: [{
                        label: '',
                        data: [acceptCount, rejectCount],
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)', // Green
                            'rgba(244, 67, 54, 0.8)' // Red
                        ],
                        borderColor: [
                            'rgba(76, 175, 80, 1)', // Green
                            'rgba(244, 67, 54, 1)' // Red
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    animation: { duration: 0 }, // Deaktiviere Animationen
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cookie-Entscheidungen der Teilnehmer',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    maintainAspectRatio: false // Wichtig, damit Chart sich an Container anpasst
                }
            });
        }
        
        // Cookie-Daten laden
        function loadCookieData() {
            console.log("Cookie-Daten werden geladen"); // Debug-Meldung
            
            // Zeige Ladeindikator
            document.getElementById('cookie-loading').classList.remove('hidden');
            
            // Lade Daten aus Firebase
            db.collection("cookieChoices").get()
                .then((querySnapshot) => {
                    // Zähle Akzeptiert und Abgelehnt
                    let acceptCount = 0;
                    let rejectCount = 0;
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.choice === 'accept') {
                            acceptCount++;
                        } else if (data.choice === 'reject') {
                            rejectCount++;
                        }
                    });
                    
                    const totalCount = acceptCount + rejectCount;
                    
                    // Berechne und aktualisiere die Akzeptanzrate
                    const acceptRate = totalCount > 0 ? 
                        Math.round((acceptCount / totalCount) * 100) : 0;
                    
                    // Aktualisiere Diagramm
                    initCookieChart(acceptCount, rejectCount);
                    
                    // Aktualisiere Statistik-Zusammenfassung
                    document.getElementById("accept-count").textContent = acceptCount;
                    document.getElementById("reject-count").textContent = rejectCount;
                    document.getElementById("total-count").textContent = totalCount;
                    document.getElementById("accept-rate").textContent = acceptRate + "%";
                    
                    // Verstecke Ladeindikator
                    document.getElementById('cookie-loading').classList.add('hidden');
                })
                .catch((error) => {
                    console.error("Fehler beim Laden der Cookie-Daten: ", error);
                    alert("Beim Laden der Cookie-Daten ist ein Fehler aufgetreten.");
                    document.getElementById('cookie-loading').classList.add('hidden');
                });
        }
        
        // Cookie-Daten herunterladen
        function downloadCookieData() {
            db.collection("cookieChoices").get()
                .then((querySnapshot) => {
                    let csvContent = "data:text/csv;charset=utf-8,userId,choice,timestamp\n";
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        csvContent += `${data.userId},${data.choice},${data.timestamp}\n`;
                    });
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "cookie_choices.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch((error) => {
                    console.error("Fehler beim Herunterladen der Cookie-Daten: ", error);
                    alert("Beim Herunterladen der Cookie-Daten ist ein Fehler aufgetreten.");
                });
        }
        
        // Cookie-Daten zurücksetzen
        function resetCookieData() {
            // Sammle alle zu löschenden Dokumente
            db.collection("cookieChoices").get()
                .then((querySnapshot) => {
                    const batch = db.batch();
                    
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    
                    return batch.commit();
                })
                .then(() => {
                    alert("Alle Cookie-Daten wurden zurückgesetzt.");
                    resetCookiesConfirm.classList.add("hidden");
                    loadCookieData();
                })
                .catch((error) => {
                    console.error("Fehler beim Zurücksetzen der Cookie-Daten: ", error);
                    alert("Beim Zurücksetzen der Cookie-Daten ist ein Fehler aufgetreten.");
                });
        }
        
        // ========== SURVEY DASHBOARD FUNCTIONS ==========
        
        // Survey-Diagramm initialisieren
        function initSurveyChart(yesCount, noCount) {
            console.log("Survey-Chart wird initialisiert"); // Debug-Meldung
            const ctx = document.getElementById('survey-chart').getContext('2d');
            
            // Zerstöre vorhandenes Diagramm
            if (surveyChart !== null) {
                surveyChart.destroy();
            }
            
            surveyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ja', 'Nein'],
                    datasets: [{
                        label: '',
                        data: [yesCount, noCount],
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)', // Green
                            'rgba(244, 67, 54, 0.8)' // Red
                        ],
                        borderColor: [
                            'rgba(76, 175, 80, 1)', // Green
                            'rgba(244, 67, 54, 1)' // Red
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    animation: { duration: 0 }, // Deaktiviere Animationen
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Organspende-Präferenzen',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    maintainAspectRatio: false // Wichtig, damit Chart sich an Container anpasst
                }
            });
        }
        
        // Survey-Daten laden
        function loadSurveyData() {
            console.log("Survey-Daten werden geladen"); // Debug-Meldung
            
            // Zeige Ladeindikator
            document.getElementById('survey-loading').classList.remove('hidden');
            
            // Lade Daten aus Firebase
            db.collection("surveyAnswers").get()
                .then((querySnapshot) => {
                    // Zähle Ja und Nein Antworten
                    let yesCount = 0;
                    let noCount = 0;
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.answer === 'yes') {
                            yesCount++;
                        } else if (data.answer === 'no') {
                            noCount++;
                        }
                    });
                    
                    const totalCount = yesCount + noCount;
                    
                    // Berechne und aktualisiere die Ja-Rate
                    const yesRate = totalCount > 0 ? 
                        Math.round((yesCount / totalCount) * 100) : 0;
                    
                    // Aktualisiere Diagramm
                    initSurveyChart(yesCount, noCount);
                    
                    // Aktualisiere Statistik-Zusammenfassung
                    document.getElementById("yes-count").textContent = yesCount;
                    document.getElementById("no-count").textContent = noCount;
                    document.getElementById("survey-total-count").textContent = totalCount;
                    document.getElementById("yes-rate").textContent = yesRate + "%";
                    
                    // Verstecke Ladeindikator
                    document.getElementById('survey-loading').classList.add('hidden');
                })
                .catch((error) => {
                    console.error("Fehler beim Laden der Survey-Daten: ", error);
                    alert("Beim Laden der Survey-Daten ist ein Fehler aufgetreten.");
                    document.getElementById('survey-loading').classList.add('hidden');
                });
        }
        
        // Survey-Daten herunterladen
        function downloadSurveyData() {
            db.collection("surveyAnswers").get()
                .then((querySnapshot) => {
                    let csvContent = "data:text/csv;charset=utf-8,userId,answer,timestamp\n";
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        csvContent += `${data.userId},${data.answer},${data.timestamp}\n`;
                    });
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "survey_answers.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch((error) => {
                    console.error("Fehler beim Herunterladen der Survey-Daten: ", error);
                    alert("Beim Herunterladen der Survey-Daten ist ein Fehler aufgetreten.");
                });
        }
        
        // Survey-Daten zurücksetzen
        function resetSurveyData() {
            // Sammle alle zu löschenden Dokumente
            db.collection("surveyAnswers").get()
                .then((querySnapshot) => {
                    const batch = db.batch();
                    
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    
                    return batch.commit();
                })
                .then(() => {
                    alert("Alle Survey-Daten wurden zurückgesetzt.");
                    resetSurveyConfirm.classList.add("hidden");
                    loadSurveyData();
                })
                .catch((error) => {
                    console.error("Fehler beim Zurücksetzen der Survey-Daten: ", error);
                    alert("Beim Zurücksetzen der Survey-Daten ist ein Fehler aufgetreten.");
                });
        }
        
        // ========== DEFAULTS DASHBOARD FUNCTIONS ==========
        
        // Defaults-Diagramm initialisieren
        function initDefaultsChart(categoryData) {
            console.log("Defaults-Chart wird initialisiert"); // Debug-Meldung
            const ctx = document.getElementById('defaults-chart').getContext('2d');
            
            // Zerstöre vorhandenes Diagramm
            if (defaultsChart !== null) {
                defaultsChart.destroy();
            }
            
            // Sortiere Kategorien nach Häufigkeit absteigend
            const sortedData = [...categoryData].sort((a, b) => b.count - a.count);
            
            defaultsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.map(item => item.category), // Kategoriename als Label
                    datasets: [{
                        label: '',
                        data: sortedData.map(item => item.count),
                        backgroundColor: sortedData.map(item => categoryColors[item.category]),
                        borderColor: sortedData.map(item => categoryBorderColors[item.category]),
                        borderWidth: 1
                    }]
                },
                options: {
                    animation: { duration: 0 }, // Deaktiviere Animationen
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            display: false // Verstecke die x-Achsen-Beschriftungen
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Default-Kategorien',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    maintainAspectRatio: false // Wichtig, damit Chart sich an Container anpasst
                }
            });
            
            // Aktualisiere die Labels unter dem Diagramm
            updateChartLabels(sortedData);
        }
        
        // Chart Labels aktualisieren
        function updateChartLabels(sortedData) {
            let labelsHTML = '';
            
            sortedData.forEach(item => {
                labelsHTML += `<div class="chart-label" style="color: ${categoryBorderColors[item.category]}">${item.category}</div>`;
            });
            
            chartLabels.innerHTML = labelsHTML;
        }
        
        // Defaults-Daten laden
        function loadDefaultsData() {
            console.log("Defaults-Daten werden geladen"); // Debug-Meldung
            
            // Zeige Ladeindikator
            document.getElementById('defaults-loading').classList.remove('hidden');
            
            // Lade Daten aus Firebase
            db.collection("userDefaults").get()
                .then((querySnapshot) => {
                    const allDefaults = [];
                    
                    querySnapshot.forEach((doc) => {
                        allDefaults.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Kategorien definieren
                    const categories = ['gesund', 'ungesund', 'spart Geld', 'kostet Geld', 
                                        'schützt Privatsphäre', 'verletzt Privatsphäre', 
                                        'fördert Nachhaltigkeit', 'ist umweltschädlich'];
                    
                    // Zählen der Defaults pro Kategorie
                    const categoryData = categories.map(category => {
                        const defaultsInCategory = allDefaults.filter(d => d.category === category);
                        return {
                            category: category,
                            count: defaultsInCategory.length,
                            defaults: defaultsInCategory
                        };
                    });
                    
                    // Aktualisiere Diagramm
                    initDefaultsChart(categoryData);
                    
                    // Aktualisiere Kategorie-Liste
                    updateCategoryDisplay(categoryData);
                    
                    // Verstecke Ladeindikator
                    document.getElementById('defaults-loading').classList.add('hidden');
                })
                .catch((error) => {
                    console.error("Fehler beim Laden der Defaults-Daten: ", error);
                    alert("Beim Laden der Defaults-Daten ist ein Fehler aufgetreten.");
                    document.getElementById('defaults-loading').classList.add('hidden');
                });
        }
        
        // Kategorie-Anzeige aktualisieren
        function updateCategoryDisplay(categoryData) {
            // Sortiere Kategorien nach Häufigkeit absteigend
            const sortedData = [...categoryData].sort((a, b) => b.count - a.count);
            
            let displayHTML = '';
            
            sortedData.forEach(item => {
                if (item.count > 0) { // Zeige nur Kategorien mit mindestens einem Eintrag
                    // Setze Kategorie-Header-Farbe auf die gleiche Farbe wie im Diagramm
                    displayHTML += `
                        <div class="category-entries">
                            <div class="category-header" style="background-color: ${categoryColors[item.category]}">
                                <span class="category-title">${item.category}</span>
                                <span class="category-count">${item.count}</span>
                            </div>
                            <div class="category-entries-list">
                    `;
                    
                    item.defaults.forEach(defaultItem => {
                        displayHTML += `<div class="entry-item">${defaultItem.text}</div>`;
                    });
                    
                    displayHTML += `
                            </div>
                        </div>
                    `;
                }
            });
            
            // Wenn keine Daten vorhanden sind
            if (displayHTML === '') {
                displayHTML = '<p>Keine Default-Daten vorhanden.</p>';
            }
            
            categoryContainer.innerHTML = displayHTML;
        }
        
        // Defaults-Daten herunterladen
        function downloadDefaultsData() {
            db.collection("userDefaults").get()
                .then((querySnapshot) => {
                    let csvContent = "data:text/csv;charset=utf-8,userId,text,category,timestamp\n";
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        csvContent += `${data.userId},"${data.text.replace(/"/g, '""')}",${data.category},${data.timestamp}\n`;
                    });
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "user_defaults.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch((error) => {
                    console.error("Fehler beim Herunterladen der Defaults-Daten: ", error);
                    alert("Beim Herunterladen der Defaults-Daten ist ein Fehler aufgetreten.");
                });
        }
        
        // Defaults-Daten zurücksetzen
        function resetDefaultsData() {
            // Sammle alle zu löschenden Dokumente
            db.collection("userDefaults").get()
                .then((querySnapshot) => {
                    const batch = db.batch();
                    
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    
                    return batch.commit();
                })
                .then(() => {
                    alert("Alle Defaults-Daten wurden zurückgesetzt.");
                    resetDefaultsConfirm.classList.add("hidden");
                    loadDefaultsData();
                })
                .catch((error) => {
                    console.error("Fehler beim Zurücksetzen der Defaults-Daten: ", error);
                    alert("Beim Zurücksetzen der Defaults-Daten ist ein Fehler aufgetreten.");
                });
        }
    </script>
</body>
</html>